var t=require("sax"),e=require("fs"),i=require("path"),n=require("zlib"),s=require("pend");exports.readFile=function(t,i){"undefined"!=typeof window?fetch(t).then(t=>t.text()).then(t=>{i(void 0,t)}).catch(t=>i(t)):e.readFile(t,{encoding:"utf8"},i)},exports.parseFile=P,exports.parse=w,exports.Map=k,exports.TileSet=H,exports.Image=M,exports.Tile=Y,exports.TileLayer=C,exports.ObjectLayer=F,exports.ImageLayer=D,exports.TmxObject=B,exports.Terrain=W;var a=0,r=a++,o=a++,u=a++,l=a++,c=a++,h=a++,p=a++,f=a++,b=a++,g=a++,E=a++,I=a++,T=a++,m=a++,d=a++,O=a++,y=a++,R=a++,x=a++,A=a++;function w(e,a,w){var j,U,V,z,q,J,X=i.dirname(a),K=t.parser(),Q=null,Z=r,$=new Array(20),_=0,tt=0,et=null,it=0,nt=null,st=0,at=null,rt=0,ot=0,ut=null,lt=0,ct=new s,ht=[];function pt(t){return ut.terrainTypes[parseInt(t,10)]}function ft(t){V.horizontalFlips[ot]=!!(2147483648&t),V.verticalFlips[ot]=!!(1073741824&t),V.diagonalFlips[ot]=!!(536870912&t),J.tiles[ot]=t&=536870911,ot+=1}function bt(t){var e=new M;return e.format=t.attributes.FORMAT,e.source=t.attributes.SOURCE,e.trans=t.attributes.TRANS,e.width=L(t.attributes.WIDTH),e.height=L(t.attributes.HEIGHT),It(),e}function gt(t,e){(ut=new H).firstGid=L(t.attributes.FIRSTGID),ut.source=t.attributes.SOURCE,ut.name=t.attributes.NAME,ut.tileWidth=L(t.attributes.TILEWIDTH),ut.tileHeight=L(t.attributes.TILEHEIGHT),ut.spacing=L(t.attributes.SPACING),ut.margin=L(t.attributes.MARGIN),ut.source&&ct.go(function(t){!function(t,e){P(i.join(X,t.source),function(i,n){i?e(i):(n.mergeTo(t),e())})}(ut,t)}),Z=p,lt=e}function Et(t){et=t,it=Z,Z=u}function It(){_=Z,Z=h,tt=1}function Tt(t){K.onerror=null,K.onopentag=null,K.onclosetag=null,K.ontext=null,K.onend=null,w(t)}function mt(t){for(var e=0;e<t.tiles.length;e+=1)for(var i=t.tiles[e],n=j.tileSets.length-1;n>=0;n-=1){var s=j.tileSets[n];if(s.firstGid<=i){var a=i-s.firstGid,r=s.tiles[a];r||((r=new Y).id=a,s.tiles[a]=r),r.gid=i,t.layer.tiles[e]=r;break}}}function dt(t){var e=j.width*j.height*4;if(t.length===e){ot=0;for(var i=0;i<e;i+=4)ft(t.readUInt32LE(i))}else Tt(new Error("Expected "+e+" bytes of tile data; received "+t.length))}$[r]={opentag:function(t){"MAP"===t.name?(j=new k,Q=j,j.version=t.attributes.VERSION,j.orientation=t.attributes.ORIENTATION,j.width=L(t.attributes.WIDTH),j.height=L(t.attributes.HEIGHT),j.tileWidth=L(t.attributes.TILEWIDTH),j.tileHeight=L(t.attributes.TILEHEIGHT),j.backgroundColor=t.attributes.BACKGROUNDCOLOR,Z=o):"TILESET"===t.name?(gt(t,r),Q=ut):It()},closetag:S,text:S},$[o]={opentag:function(t){switch(t.name){case"PROPERTIES":Et(j.properties);break;case"TILESET":gt(t,o),j.tileSets.push(ut);break;case"LAYER":V=new C(j),ot=0,V.name=t.attributes.NAME,V.opacity=N(t.attributes.OPACITY,1),V.visible=G(t.attributes.VISIBLE,!0),j.layers.push(V),J={layer:V,tiles:new Array(j.width*j.height)},ht.push(J),Z=b;break;case"OBJECTGROUP":(V=new F).name=t.attributes.NAME,V.color=t.attributes.COLOR,V.opacity=N(t.attributes.OPACITY,1),V.visible=G(t.attributes.VISIBLE,!0),j.layers.push(V),Z=g;break;case"IMAGELAYER":(V=new D).name=t.attributes.NAME,V.x=L(t.attributes.X),V.y=L(t.attributes.Y),V.opacity=N(t.attributes.OPACITY,1),V.visible=G(t.attributes.VISIBLE,!0),j.layers.push(V),Z=T;break;default:It()}},closetag:S,text:S},$[p]={opentag:function(t){switch(t.name){case"TILEOFFSET":ut.tileOffset.x=L(t.attributes.X),ut.tileOffset.y=L(t.attributes.Y),It();break;case"PROPERTIES":Et(ut.properties);break;case"IMAGE":ut.image=bt(t);break;case"TERRAINTYPES":Z=x;break;case"TILE":if((U=new Y).id=L(t.attributes.ID),t.attributes.TERRAIN){var e=t.attributes.TERRAIN.split(",");U.terrain=e.map(pt)}U.probability=N(t.attributes.PROBABILITY),ut.tiles[U.id]=U,Z=f;break;default:It()}},closetag:function(t){Z=lt},text:S},$[u]={opentag:function(t){"PROPERTY"===t.name&&(et[t.attributes.NAME]=function(t,e){switch(e){case"int":return parseInt(t,10);case"float":return parseFloat(t,2);case"bool":return"true"===t;default:return t}}(t.attributes.VALUE,t.attributes.TYPE)),It()},closetag:function(t){Z=it},text:S},$[l]={opentag:function(t){"FRAME"===t.name&&nt.push({tileId:t.attributes.TILEID,duration:t.attributes.DURATION}),It()},closetag:function(t){Z=st},text:S},$[c]={opentag:function(t){"OBJECT"===t.name?((z=new B).name=t.attributes.NAME,z.type=t.attributes.TYPE,z.x=L(t.attributes.X),z.y=L(t.attributes.Y),z.width=L(t.attributes.WIDTH,0),z.height=L(t.attributes.HEIGHT,0),z.rotation=N(t.attributes.ROTATION,0),z.gid=L(t.attributes.GID),z.visible=G(t.attributes.VISIBLE,!0),at.push(z),Z=I):It()},closetag:function(t){Z=rt},text:S},$[h]={opentag:function(t){tt+=1},closetag:function(t){0==(tt-=1)&&(Z=_)},text:S},$[f]={opentag:function(t){"PROPERTIES"===t.name?Et(U.properties):"IMAGE"===t.name?U.image=bt(t):"ANIMATION"===t.name?U.animation=(nt=U.animations,st=Z,void(Z=l)):"OBJECTGROUP"===t.name?U.objectGroup=(at=U.objectGroups,rt=Z,void(Z=c)):It()},closetag:function(t){Z=p},text:S},$[b]={opentag:function(t){if("PROPERTIES"===t.name)Et(V.properties);else if("DATA"===t.name){var e=t.attributes.ENCODING,i=t.attributes.COMPRESSION;switch(e){case void 0:case null:Z=m;break;case"csv":Z=d;break;case"base64":switch(i){case void 0:case null:Z=O;break;case"gzip":Z=y;break;case"zlib":Z=R;break;default:return void Tt(new Error("unsupported data compression: "+i))}break;default:return void Tt(new Error("unsupported data encoding: "+e))}}else It()},closetag:function(t){Z=o},text:S},$[g]={opentag:function(t){"PROPERTIES"===t.name?Et(V.properties):"OBJECT"===t.name?((z=new B).name=t.attributes.NAME,z.type=t.attributes.TYPE,z.x=L(t.attributes.X),z.y=L(t.attributes.Y),z.width=L(t.attributes.WIDTH,0),z.height=L(t.attributes.HEIGHT,0),z.rotation=N(t.attributes.ROTATION,0),z.gid=L(t.attributes.GID),z.visible=G(t.attributes.VISIBLE,!0),V.objects.push(z),Z=E):It()},closetag:function(t){Z=o},text:S},$[T]={opentag:function(t){"PROPERTIES"===t.name?Et(V.properties):"IMAGE"===t.name?V.image=bt(t):It()},closetag:function(t){Z=o},text:S},$[E]={opentag:function(t){switch(t.name){case"PROPERTIES":Et(z.properties);break;case"ELLIPSE":z.ellipse=!0,It();break;case"POLYGON":z.polygon=v(t.attributes.POINTS),It();break;case"POLYLINE":z.polyline=v(t.attributes.POINTS),It();break;case"IMAGE":z.image=bt(t);break;default:It()}},closetag:function(t){Z=g},text:S},$[I]={opentag:function(t){switch(t.name){case"PROPERTIES":Et(z.properties);break;case"ELLIPSE":z.ellipse=!0,It();break;case"POLYGON":z.polygon=v(t.attributes.POINTS),It();break;case"POLYLINE":z.polyline=v(t.attributes.POINTS),It();break;case"IMAGE":z.image=bt(t);break;default:It()}},closetag:function(t){Z=c},text:S},$[m]={opentag:function(t){"TILE"===t.name&&ft(L(t.attributes.GID,0)),It()},closetag:function(t){Z=b},text:S},$[d]={opentag:function(t){It()},closetag:function(t){Z=b},text:function(t){t.split(",").forEach(function(t){ft(parseInt(t,10))})}},$[O]={opentag:function(t){It()},closetag:function(t){Z=b},text:function(t){dt(new Buffer(t.trim(),"base64"))}},$[y]={opentag:function(t){It()},closetag:function(t){Z=b},text:function(t){var e=new Buffer(t.trim(),"base64"),i=J,s=V;ct.go(function(t){n.gunzip(e,function(e,n){e?t(e):(J=i,V=s,dt(n),t())})})}},$[R]={opentag:function(t){It()},closetag:function(t){Z=b},text:function(t){var e=new Buffer(t.trim(),"base64"),i=J,s=V;ct.go(function(t){n.inflate(e,function(e,n){e?t(e):(V=s,J=i,dt(n),t())})})}},$[x]={opentag:function(t){"TERRAIN"===t.name?((q=new W).name=t.attributes.NAME,q.tile=L(t.attributes.TILE),ut.terrainTypes.push(q),Z=A):It()},closetag:function(t){Z=p},text:S},$[A]={opentag:function(t){"PROPERTIES"===t.name?Et(q.properties):It()},closetag:function(t){Z=x},text:S},K.onerror=w,K.onopentag=function(t){$[Z].opentag(t)},K.onclosetag=function(t){$[Z].closetag(t)},K.ontext=function(t){$[Z].text(t)},K.onend=function(){ct.wait(function(t){t?w(t):(ht.forEach(mt),w(null,Q))})},K.write(e).close()}function P(t,e){exports.readFile(t,function(i,n){i?e(i):w(n,t,e)})}function v(t){return t.split(" ").map(function(t){var e=t.split(",");return{x:e[0],y:e[1]}})}function S(){}function L(t,e){return e=null==e?null:e,null==t?e:parseInt(t,10)}function G(t,e){return e=null==e?null:e,null==t?e:!!parseInt(t,10)}function N(t,e){return e=null==e?null:e,null==t?e:parseFloat(t,10)}function k(){this.version=null,this.orientation="orthogonal",this.width=0,this.height=0,this.tileWidth=0,this.tileHeight=0,this.backgroundColor=null,this.layers=[],this.properties={},this.tileSets=[]}function H(){this.firstGid=0,this.source="",this.name="",this.tileWidth=0,this.tileHeight=0,this.spacing=0,this.margin=0,this.tileOffset={x:0,y:0},this.properties={},this.image=null,this.tiles=[],this.terrainTypes=[]}function M(){this.format=null,this.source="",this.trans=null,this.width=0,this.height=0}function Y(){this.id=0,this.terrain=[],this.probability=null,this.properties={},this.animations=[],this.objectGroups=[],this.image=null}function C(t){var e=t.width*t.height;this.map=t,this.type="tile",this.name=null,this.opacity=1,this.visible=!0,this.properties={},this.tiles=new Array(e),this.horizontalFlips=new Array(e),this.verticalFlips=new Array(e),this.diagonalFlips=new Array(e)}function F(){this.type="object",this.name=null,this.color=null,this.opacity=1,this.visible=!0,this.properties={},this.objects=[]}function D(){this.type="image",this.name=null,this.x=0,this.y=0,this.opacity=1,this.visible=!0,this.properties={},this.image=null}function B(){this.name=null,this.type=null,this.x=0,this.y=0,this.width=0,this.height=0,this.rotation=0,this.properties={},this.gid=null,this.visible=!0,this.ellipse=!1,this.polygon=null,this.polyline=null}function W(){this.name="",this.tile=0,this.properties={}}H.prototype.mergeTo=function(t){t.firstGid=null==this.firstGid?t.firstGid:this.firstGid,t.source=null==this.source?t.source:this.source,t.name=null==this.name?t.name:this.name,t.tileWidth=null==this.tileWidth?t.tileWidth:this.tileWidth,t.tileHeight=null==this.tileHeight?t.tileHeight:this.tileHeight,t.spacing=null==this.spacing?t.spacing:this.spacing,t.margin=null==this.margin?t.margin:this.margin,t.tileOffset=null==this.tileOffset?t.tileOffset:this.tileOffset,t.properties=null==this.properties?t.properties:this.properties,t.image=null==this.image?t.image:this.image,t.tiles=null==this.tiles?t.tiles:this.tiles,t.terrainTypes=null==this.terrainTypes?t.terrainTypes:this.terrainTypes},C.prototype.tileAt=function(t,e){return this.tiles[e*this.map.width+t]},C.prototype.setTileAt=function(t,e,i){this.tiles[e*this.map.width+t]=i};
//# sourceMappingURL=tmx-parser.modern.js.map
